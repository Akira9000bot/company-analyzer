#!/bin/bash
#
# analyze - Simple Telegram Interface for Company Analyzer Skill
# Usage: ./analyze <TICKER> [PROMPT_NUMBER|"live"]
#
# Examples:
#   ./analyze AAPL           # Full LIVE analysis (8 frameworks + thesis) ~$0.04
#   ./analyze AAPL 3         # Single framework (or cache retrieve)
#   ./analyze AAPL live      # Force live mode explicitly
#

set -euo pipefail

TICKER="${1:-}"
PROMPT="${2:-}"

if [ -z "$TICKER" ]; then
    echo "Usage: ./analyze <TICKER> [PROMPT_NUMBER|live]"
    echo ""
    echo "Examples:"
    echo "  ./analyze AAPL           # Full LIVE analysis (~$0.04)"
    echo "  ./analyze AAPL 3         # AI Moat only (cache or generate)"
    echo "  ./analyze AAPL live      # Force live mode"
    echo ""
    echo "Framework numbers:"
    echo "  1 = Phase Classification"
    echo "  2 = Key Metrics Scorecard"
    echo "  3 = AI Moat Viability"
    echo "  4 = Strategic Moat Assessment"
    echo "  5 = Price & Sentiment"
    echo "  6 = Growth Drivers"
    echo "  7 = Business Model"
    echo "  8 = Risk Analysis"
    exit 1
fi

TICKER_UPPER=$(echo "$TICKER" | tr '[:lower:]' '[:upper:]')
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"
OUTPUTS_DIR="$SKILL_DIR/assets/outputs"

# Map numbers to framework IDs
declare -A NUM_MAP=(
    ["1"]="01-phase"
    ["2"]="02-metrics"
    ["3"]="03-ai-moat"
    ["4"]="04-strategic-moat"
    ["5"]="05-sentiment"
    ["6"]="06-growth"
    ["7"]="07-business"
    ["8"]="08-risk"
)

# Check if data exists, fetch if not
DATA_FILE="/tmp/company-analyzer-cache/${TICKER_UPPER}_data.json"
if [ ! -f "$DATA_FILE" ]; then
    echo "ðŸ“Š Fetching data for $TICKER_UPPER..."
    "$SCRIPT_DIR/fetch_data.sh" "$TICKER_UPPER" 2>&1 | tail -5
    echo ""
fi

# Mode: Live full analysis (default when no prompt specified)
if [ -z "$PROMPT" ] || [ "$PROMPT" = "live" ]; then
    echo "ðŸš€ Running FULL LIVE ANALYSIS for $TICKER_UPPER"
    echo "   This will:"
    echo "   â€¢ Analyze 8 frameworks via API (~$0.024)"
    echo "   â€¢ Generate investment thesis (~$0.01)"
    echo "   â€¢ Total cost: ~$0.034"
    echo ""
    
    # Run the live analysis script
    "$SCRIPT_DIR/analyze-live.sh" "$TICKER_UPPER" --live
    exit $?
fi

# Mode: Single prompt
FRAMEWORK_ID="${NUM_MAP[$PROMPT]:-}"

if [ -z "$FRAMEWORK_ID" ]; then
    echo "âŒ Invalid prompt number: $PROMPT"
    echo "Use 1-8 for specific frameworks"
    exit 1
fi

# Check cache first
CACHE_FILE="$OUTPUTS_DIR/${TICKER_UPPER}_${FRAMEWORK_ID}.md"
if [ -f "$CACHE_FILE" ]; then
    # Check if it's a live analysis or just template
    if grep -q "Live Analysis Complete\|Live Generated" "$CACHE_FILE" 2>/dev/null; then
        echo "âœ… Found LIVE analysis for $TICKER_UPPER (framework $PROMPT)"
        echo ""
        cat "$CACHE_FILE"
        exit 0
    fi
fi

# Run single framework LIVE
echo "ðŸ” Analyzing $TICKER_UPPER - Framework $PROMPT (LIVE)..."
echo ""
"$SCRIPT_DIR/analyze-live.sh" "$TICKER_UPPER" --live 2>&1 | grep -A50 "\[0$PROMPT\]"

# Show result
if [ -f "$CACHE_FILE" ]; then
    echo ""
    echo "âœ… Analysis complete!"
    echo ""
    cat "$CACHE_FILE"
fi

exit 0
